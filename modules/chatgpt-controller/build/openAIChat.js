"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,a){return new(r||(r=Promise))((function(o,n){function s(e){try{l(a.next(e))}catch(e){n(e)}}function u(e){try{l(a.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,u)}l((a=a.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var r,a,o,n,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return n={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function u(u){return function(l){return function(u){if(r)throw new TypeError("Generator is already executing.");for(;n&&(n=0,u[0]&&(s=0)),s;)try{if(r=1,a&&(o=2&u[0]?a.return:u[0]?a.throw||((o=a.return)&&o.call(a),0):a.next)&&!(o=o.call(a,u[1])).done)return o;switch(a=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,a=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){s=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){s.label=u[1];break}if(6===u[0]&&s.label<o[1]){s.label=o[1],o=u;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(u);break}o[2]&&s.ops.pop(),s.trys.pop();continue}u=t.call(e,s)}catch(e){u=[6,e],a=0}finally{r=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,l])}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.openAIChat=void 0;var puppeteer_utils_1=require("puppeteer-utils"),chatGPTAuth_1=require("./chatGPTAuth"),detectChatGptPage_1=require("./detectChatGptPage"),html_to_md_1=__importDefault(require("html-to-md")),openAIChat=function(e){return __awaiter(void 0,void 0,void 0,(function(){var t,r,a,o,n,s,u,l;return __generator(this,(function(i){switch(i.label){case 0:return t=e.prompt,r=e.thread,e.isHeadless,console.log("openAIChat Called",e),[4/*yield*/,(0,puppeteer_utils_1.openPage)(r)];case 1:return(a=i.sent())?[4/*yield*/,a.target()._targetId]:[2/*return*/,{isSuccessful:!1,message:"Faild to create page."}];case 2:
//setting current page is not idle
return o=i.sent(),[4/*yield*/,(0,puppeteer_utils_1.setBrowserPageIdle)(o,!1)];case 3:
//setting current page is not idle
return i.sent(),r===o?[3/*break*/,5]:[4/*yield*/,a.goto("https://chat.openai.com/chat",{waitUntil:"domcontentloaded"})];case 4:i.sent(),i.label=5;case 5:return[4/*yield*/,a.$('button[class="absolute p-1 rounded-md text-gray-500 bottom-1.5 right-1 md:bottom-2.5 md:right-2 hover:bg-gray-100 dark:hover:text-gray-400 dark:hover:bg-gray-900 disabled:hover:bg-transparent dark:disabled:hover:bg-transparent"]')];case 6:return n=i.sent(),[4/*yield*/,a.$("textarea")];case 7:return i.sent()&&n?[3/*break*/,11]:[4/*yield*/,(0,detectChatGptPage_1.detectChatGptPage)(a)];case 8:return s=i.sent(),console.log({pageType:s}),"Login"!==s?[3/*break*/,11]:[4/*yield*/,(0,chatGPTAuth_1.chatGPTAuth)(a)];case 9:
// console.log({ authResponse });
return i.sent(),[4/*yield*/,new Promise((function(e){return setTimeout(e,5e3)}))];case 10:
// console.log({ authResponse });
i.sent(),i.label=11;case 11:
// Wating and typing the prompt in the textarea field
return[4/*yield*/,a.waitForSelector("textarea",{timeout:6e4})];case 12:
// Wating and typing the prompt in the textarea field
return i.sent(),[4/*yield*/,a.waitForSelector('button[class="absolute p-1 rounded-md text-gray-500 bottom-1.5 right-1 md:bottom-2.5 md:right-2 hover:bg-gray-100 dark:hover:text-gray-400 dark:hover:bg-gray-900 disabled:hover:bg-transparent dark:disabled:hover:bg-transparent"]',{timeout:6e4})];case 13:return i.sent(),[4/*yield*/,a.$('button[class="absolute p-1 rounded-md text-gray-500 bottom-1.5 right-1 md:bottom-2.5 md:right-2 hover:bg-gray-100 dark:hover:text-gray-400 dark:hover:bg-gray-900 disabled:hover:bg-transparent dark:disabled:hover:bg-transparent"]')];case 14:return n=i.sent(),[4/*yield*/,a.$("textarea")];case 15:return i.sent()&&n?(console.log("inside of set value"),[4/*yield*/,new Promise((function(e,r){return __awaiter(void 0,void 0,void 0,(function(){var r;return __generator(this,(function(o){switch(o.label){case 0:return console.log("inside promise"),r=e,[4/*yield*/,a.evaluate((function(e){var t=document.getElementsByTagName("textarea");if(console.log({promtTextAreaField:t}),t[0]){
//@ts-ignore
t[0].focus(),t[0].click(),t[0].value=e;var r=document.querySelector('button[class="absolute p-1 rounded-md text-gray-500 bottom-1.5 right-1 md:bottom-2.5 md:right-2 hover:bg-gray-100 dark:hover:text-gray-400 dark:hover:bg-gray-900 disabled:hover:bg-transparent dark:disabled:hover:bg-transparent"]');
//@ts-ignore
return null==r||r.click(),!0}console.log("TEXT AREA NOT FOUND")}),t)];case 1:return r.apply(void 0,[o.sent()]),[2/*return*/]}}))}))}))]):[2/*return*/,{isSuccessful:!1,message:"Text area not found",result:{thread:o}}];case 16:
// Waiting for re-appear send message button that show current prompt is completed
return i.sent(),[4/*yield*/,a.waitForSelector('button[class="absolute p-1 rounded-md text-gray-500 bottom-1.5 right-1 md:bottom-2.5 md:right-2 hover:bg-gray-100 dark:hover:text-gray-400 dark:hover:bg-gray-900 disabled:hover:bg-transparent dark:disabled:hover:bg-transparent"]',{timeout:3e5})];case 17:
// Waiting for re-appear send message button that show current prompt is completed
return i.sent(),console.log("ANSWER IS COMPLETED"),[4/*yield*/,new Promise((function(e,t){return __awaiter(void 0,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:return t=e,[4/*yield*/,a.evaluate((function(){
// document.title = "bhagya 1234";
var e=document.querySelectorAll('div[class="w-full border-b border-black/10 dark:border-gray-900/50 text-gray-800 dark:text-gray-100 group bg-gray-50 dark:bg-[#444654]"]');console.log({allAnswer:e});var t="";return e.length>0&&(t=e[e.length-1].outerHTML,console.log({lastAnswer:t})),t}))];case 1:return t.apply(void 0,[r.sent()]),[2/*return*/]}}))}))}))];case 18:return(u=i.sent())?(l=(0,html_to_md_1.default)(u),[4/*yield*/,(0,puppeteer_utils_1.setBrowserPageIdle)(o,!0)]):[2/*return*/,{isSuccessful:!1,message:"Empty result found"}];case 19:
//Setting page back to idle for next prompt
return i.sent(),[2/*return*/,{isSuccessful:!0,message:"Successfully done",result:{text:l,thread:o}}]}}))}))};exports.openAIChat=openAIChat;
//# sourceMappingURL=openAIChat.js.map