"use strict";var __assign=this&&this.__assign||function(){return __assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},__assign.apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{l(r.next(e))}catch(e){a(e)}}function s(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}l((r=r.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,o=0,a=t.length;o<a;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.rebuildOperation=void 0;
// node wrappers
var run_child_process_1=require("run-child-process"),log_1=require("log"),get_package_json_1=require("get-package-json"),cleanup_typescript_database_1=require("cleanup-typescript-database"),database_1=require("database"),generate_index_1=require("generate-index"),js_util_1=require("js-util"),operation_util_1=require("operation-util"),markdown_parsings_1=require("markdown-parsings"),one_by_one_1=require("one-by-one"),get_package_source_paths_1=require("get-package-source-paths"),lint_1=require("lint"),get_path_1=require("get-path"),fs_util_1=require("fs-util"),filename_conventions_1=require("filename-conventions"),shouldSkip_1=require("./shouldSkip"),isOperationBuildNeeded_1=require("./isOperationBuildNeeded"),yarnBuild_1=require("./yarnBuild"),exitIfProcessDependenciesChange_1=require("./exitIfProcessDependenciesChange"),executeCommandQuietUnlessFail_1=require("./executeCommandQuietUnlessFail"),isSdkOperation_1=require("./isSdkOperation"),generateJsonSchemas_1=require("./generateJsonSchemas"),rebuildOperation=function(e){return __awaiter(void 0,void 0,void 0,(function(){var t,n,r,o,a,i,s,l,c,u,p,d,_,g,m,f,h,b,y,v,P,x,k,j,w,O,N,q;return __generator(this,(function(R){switch(R.label){case 0:return t=e.operationBasePath,n=e.force,r=e.debug,o=e.noExit,a=e.stack,i=void 0===a?[]:a,s=e.updatedAt,l=e.noUnresolvedRebuilding,c=e.operationManualProjectRoot,u=e.typerepoManualProjectRoot,p=e.filePaths,d=(0,fs_util_1.getLastFolder)(t),[4/*yield*/,(0,get_package_json_1.getPackageJson)({operationFolderPath:t})];case 1:return _=R.sent(),(0,isSdkOperation_1.isSdkOperation)(t)||(0,filename_conventions_1.isGeneratedOperation)(t)?(console.log("not going to rebuild sdk operation: ".concat(d)),[2/*return*/,!1]):(g="".concat(i.map((function(){return"--"})).join("")).concat(d,": "),(0,log_1.log)("".concat(g,"Rebuilding").concat(i.length>0?"(coming from ".concat(i.join(", "),")"):""),{type:"important"}),(0,log_1.log)("".concat(g,"Pre-index lint"),{type:"important"}),[4/*yield*/,(0,lint_1.preIndexLint)({operationFolderPath:t})]);case 2:return(m=R.sent()).length>0?((0,log_1.log)("".concat(g,"Operation cannot be built, we've got problem(s)"),{type:"warning"}),(0,log_1.log)(m.join("\n"),{type:"warning"}),[4/*yield*/,database_1.db.update("OperationIndex",(function(){return!0}),(function(e){return __assign(__assign({},e),{lintProblems:m})}),{operationName:d})]):[3/*break*/,4];case 3:return R.sent(),[2/*return*/,!1];case 4:return[4/*yield*/,(0,shouldSkip_1.shouldSkip)({operationBasePath:t,debug:r,force:n,rebuildUpdatedAt:s,operationManualProjectRoot:c})];case 5:return R.sent()?((0,log_1.log)("Skipping ".concat(d)),[2/*return*/,!0]):[4/*yield*/,(0,cleanup_typescript_database_1.cleanupTsDatabase)(d,c)];case 6:return f=R.sent(),(0,log_1.log)((null==f?void 0:f.amountRemoved)?"Removed ".concat(null==f?void 0:f.amountRemoved," ts db instances"):"Nothing to clean up",{type:"success"}),(0,executeCommandQuietUnlessFail_1.executeCommandQuietUnlessFail)({command:"yarn --offline",cwd:t,description:"".concat(g,"Installing")}),
// 2a) finding imports/exports and writing them to index
// TODO: we can also just check if build folder and index.js exist before looking at the import statements. These are easy to detect and when that happens we don't need to do the things below.
(0,log_1.log)("".concat(g,"Getting imports/exports"),{type:"important"}),[4/*yield*/,(0,run_child_process_1.runChildProcess)({operationFolderName:"get-imports-exports",scriptFileName:"findAndWriteImportsExports.cli",args:[t,c]})];case 7:return R.sent(),"sdk"===d?[3/*break*/,15]:[4/*yield*/,database_1.db.get("TsImport",{operationName:d,manualProjectRoot:c})];case 8:return j=R.sent(),(h=j.filter((function(e){return e.isAbsolute&&e.isModuleFromMonorepo&&!e.isModuleResolved})).map((function(e){return e.module})).filter(js_util_1.onlyUnique)).length>0?l?((0,log_1.log)("rebuilding the unresolved modules didn't work. Probably some indexation fails!",{type:"error"}),[4/*yield*/,database_1.db.update("OperationIndex",(function(){return!0}),(function(e){return __assign(__assign({},e),{dependenciesBuildsFailed:!0})}),{operationName:d,manualProjectRoot:c})]):[3/*break*/,10]:[3/*break*/,14];case 9:return R.sent(),[2/*return*/,!1];case 10:return(0,log_1.log)("".concat(g,"We need to rebuild ").concat(h.length," operations because they have conflicts (").concat(h.join(", "),")"),{type:"warning"}),[4/*yield*/,(0,one_by_one_1.oneByOne)(h,(function(e){return __awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4/*yield*/,(0,get_path_1.getOperationPath)(e,{manualProjectRoot:c})];case 1:return n.sent()?e===d||i.includes(e)?((0,log_1.log)("".concat(g,"cyclic dep"),{type:"warning"}),[2/*return*/,!1]):(console.log("".concat(g,"diving into new rebuildOperation "),{operationName:d,stack:i,unresolvedOperationName:e}),[2/*return*/,(0,exports.rebuildOperation)({operationManualProjectRoot:c,typerepoManualProjectRoot:u,operationBasePath:t,stack:i.concat([e]),debug:r,
// can't skip this one because it is a dependency
// however, skipping is very well defined. we can skip if shouldSkip is true!
// force: true,
noExit:o})]):((0,log_1.log)("".concat(g).concat(e," not found"),{type:"warning"}),[2/*return*/,!1])}}))}))}))];case 11:return b=R.sent(),(0,js_util_1.isAllTrue)(b)?[3/*break*/,13]:((0,log_1.log)("".concat(g,"something failed! returning")),[4/*yield*/,database_1.db.update("OperationIndex",(function(){return!0}),(function(e){return __assign(__assign({},e),{dependenciesBuildsFailed:!0})}),{operationName:d,manualProjectRoot:c})]);case 12:return R.sent(),[2/*return*/,!1];case 13:
// NB: all files on purpose...
return(0,log_1.log)("".concat(g,"rebuilding ourselves again")),[2/*return*/,(0,exports.rebuildOperation)({operationManualProjectRoot:c,typerepoManualProjectRoot:u,operationBasePath:t,debug:r,force:n,noExit:o,noUnresolvedRebuilding:!0,stack:i.concat([d])})];case 14:(0,log_1.log)("".concat(g,"all imports were resolved")),R.label=15;case 15:
// 2b) compiling and writing build errors to index
return(0,log_1.log)("".concat(g,"writing build errors to index"),{type:"important"}),[4/*yield*/,(0,run_child_process_1.runChildProcess)({operationFolderName:"compile-typescript",scriptFileName:"writeBuildErrors.cli",args:[t,c,u]})];case 16:return R.sent(),p?[3/*break*/,19]:(v=(y=Promise).all,[4/*yield*/,(0,get_package_source_paths_1.getPackageSourcePaths)({operationBasePath:t,ignoreIndexFiles:!0})]);case 17:return[4/*yield*/,v.apply(y,[R.sent()])];case 18:
//files from src
p=R.sent().filter(js_util_1.notEmpty),R.label=19;case 19:
// first index the files that have changed
return 0===p.length?(0,log_1.log)("".concat(g,"No files found for operation ").concat(d),{type:"error"}):(0,log_1.log)("".concat(g).concat(p.length," files to index:"),{type:"important"}),[4/*yield*/,(0,run_child_process_1.runChildProcess)({operationFolderName:"index-typescript",scriptFileName:"cli",args:__spreadArray(__spreadArray([],p,!0),[c||"null"],!1)})];case 20:
// first index the files that have changed
return R.sent(),[4/*yield*/,(0,generate_index_1.generateSimpleIndex)({operationName:d,manualProjectRoot:c})];case 21:return R.sent(),P=(0,isOperationBuildNeeded_1.isOperationBuildNeeded)(t),x=!0,P?(k=null===(q=null==_?void 0:_.sensible)||void 0===q?void 0:q.skipMinify,[4/*yield*/,(0,yarnBuild_1.yarnBuild)(t,{rmFirst:!1,skipMinify:k})]):[3/*break*/,25];case 22:return x=R.sent(),[4/*yield*/,database_1.db.get("TsImport",{manualProjectRoot:c})];case 23:return j=R.sent(),w=j.filter((function(e){return e.isModuleFromMonorepo&&e.module===d})).map((function(e){return e.operationName})).filter(js_util_1.onlyUnique).filter(js_util_1.notEmpty),O=__spreadArray([d],w,!0),N=O.map((function(e){
// NB: we need this to be a child process because it requires the tests from the index, and that file changes, while normally a require will be cached. We can't easily invalidate the cache because it can come from many files.
return(0,run_child_process_1.runChildProcess)({operationFolderName:"k-test",scriptFileName:"runTestsForOperation.cli",args:[e,c]})})),[4/*yield*/,Promise.all(N)];case 24:R.sent(),R.label=25;case 25:return[4/*yield*/,(0,generateJsonSchemas_1.generateJsonSchemas)(c,d)];case 26:return R.sent(),[4/*yield*/,database_1.db.update("OperationIndex",(function(){return!0}),(function(e){return __assign(__assign({},e),{buildSucceeded:x})}),{operationName:d,manualProjectRoot:c})];case 27:
// make a readme of the new index
return R.sent(),[4/*yield*/,(0,markdown_parsings_1.operationToMarkdown)({operationName:d,mergeDocsInline:!0,manualProjectRoot:c,returnType:"save"})];case 28:
// make a readme of the new index
return R.sent(),[4/*yield*/,database_1.db.update("OperationIndex",(function(){return!0}),(function(e){return __assign(__assign({},e),{indexImportExportError:"",lintProblems:m})}),{operationName:d,manualProjectRoot:c})];case 29:return R.sent(),[4/*yield*/,(0,operation_util_1.recalculateOperationIndexJson)(t,c)];case 30:return R.sent(),o?[3/*break*/,32]:[4/*yield*/,(0,exitIfProcessDependenciesChange_1.exitIfProcessDependenciesChanged)(d,c)];case 31:R.sent(),R.label=32;case 32:return[2/*return*/,!0]}}))}))};
// monorepo
exports.rebuildOperation=rebuildOperation;
//# sourceMappingURL=rebuildOperation.js.map