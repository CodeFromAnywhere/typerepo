"use strict";var __assign=this&&this.__assign||function(){return __assign=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var a in t=arguments[i])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},__assign.apply(this,arguments)},__spreadArray=this&&this.__spreadArray||function(e,t,i){if(i||2===arguments.length)for(var r,a=0,n=t.length;a<n;a++)!r&&a in t||(r||(r=Array.prototype.slice.call(t,0,a)),r[a]=t[a]);return e.concat(r||Array.prototype.slice.call(t))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModelComponent=void 0;var jsx_runtime_1=require("react/jsx-runtime"),api_1=require("api"),code_types_1=require("code-types"),fancy_loader_1=require("fancy-loader"),fs_util_js_1=require("fs-util-js"),js_util_1=require("js-util"),labeled_button_1=require("labeled-button"),markdown_1=require("markdown"),sdk_env_public_1=require("sdk-env-public"),react_with_native_1=require("react-with-native"),react_with_native_alert_1=require("react-with-native-alert"),react_with_native_router_1=require("react-with-native-router"),react_with_native_select_1=require("react-with-native-select"),store_1=require("../store"),CrudGrid_1=require("./CrudGrid"),CrudTable_1=require("./CrudTable"),CrudTimeline_1=require("./CrudTimeline"),CrudTree_1=require("./CrudTree"),useInfiniteGetDbModel_1=require("./useInfiniteGetDbModel"),DatasetForm_1=require("./DatasetForm"),SearchBar_1=require("./SearchBar"),deleteDbModel=api_1.api.deleteDbModel,isBetaEnabled=sdk_env_public_1.publicEnvironmentVariables.isBetaEnabled,ModelComponent=function(e){var t,i,r=e.modelName,a=e.highlight,n=(0,react_with_native_alert_1.useAlert)(),l=(0,react_with_native_router_1.useRouter)(),s=code_types_1.modelViews.map((function(e){return{value:e.view,label:"".concat(e.emoji," ").concat(e.view)}})),_=(0,react_with_native_select_1.useSelect)(s,s[0]),o=_[0],u=_[1].value,d=api_1.queries.useGetDbModelMetadata(r),c=(0,js_util_1.destructureOptionalObject)(null===(t=d.data)||void 0===t?void 0:t.result),v=c.datasets,h=c.tsInterface,m=null==v?void 0:v.map((function(e){return{label:e.name,value:e.id,data:e}})),p=__spreadArray(__spreadArray([{value:"",label:"Select a dataset"}],m||[],!0),[{value:"new",label:"(+) New dataset"}],!1),j=(0,react_with_native_select_1.useSelect)(p,void 0,(function(e){"new"!==(null==e?void 0:e.value)?""!==(null==e?void 0:e.value)?(null==e?void 0:e.data)&&x(__assign(__assign({},e.data),{key:"config".concat(Math.random())})):x(null):
// show a blank screen
x({key:"config".concat(Math.random())})}))[0],f=(0,store_1.useStore)("db-crud.datasetConfig"),b=f[0],x=f[1],g=(0,useInfiniteGetDbModel_1.useInfiniteGetDbModel)(),w=api_1.queries.useGetReferencableModelData(r),y=g.isLoading||g.isRefetching||g.isFetching,C=null===(i=null==g?void 0:g.data)||void 0===i?void 0:i.pages.map((function(e){var t;return null===(t=e.result)||void 0===t?void 0:t.data})).flat().filter(js_util_1.notEmpty),q=h?(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,{children:[(0,jsx_runtime_1.jsx)(react_with_native_1.P,__assign({className:"font-bold"},{children:h.name})),(0,jsx_runtime_1.jsx)(markdown_1.MarkdownContent,{content:h.description||"no description",config:{projectRelativeBaseFolderPath:(0,fs_util_js_1.getFolderJs)(h.projectRelativePath),projectRelativeMarkdownFilePath:h.projectRelativePath}})]}):y?(0,jsx_runtime_1.jsx)(react_with_native_1.Div,{}):"No index found",D=(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,__assign({className:"flex flex-row items-center"},{children:[(0,jsx_runtime_1.jsx)(labeled_button_1.LabeledButton,{onClick:function(){return l.push("/upsert/".concat(r))},title:"New",emoji:"➕"}),(0,jsx_runtime_1.jsx)(labeled_button_1.LabeledButton,__assign({},{onClick:function(){return g.refetch()},title:"Reload",emoji:y?void 0:"🔄",component:y?function(){return(0,jsx_runtime_1.jsx)(fancy_loader_1.FancyLoader,{medium:!0})}:void 0})),isBetaEnabled?(0,jsx_runtime_1.jsx)(o,{}):null,isBetaEnabled?(0,jsx_runtime_1.jsx)(j,{}):null,(0,jsx_runtime_1.jsx)(SearchBar_1.SearchBar,{})]})),M=[{action:function(e){null==n||n("Are you sure?","Do you want to delete this one?",[{text:"Yes",style:"destructive",onPress:function(){(null==e?void 0:e.id)&&
// console.log({ id: item.id });
deleteDbModel(r,e.id).then((function(e){g.refetch(),w.refetch()}))}},{text:"Cancel",style:"cancel"}])},emoji:"❌",name:"Delete"},{name:"Update",emoji:"✏️",action:function(e){return l.push("/upsert/".concat(r,"?id=").concat(null==e?void 0:e.id))}}],k={table:CrudTable_1.CrudTable,grid:CrudGrid_1.CrudGrid,timeline:CrudTimeline_1.CrudTimeline,tree:CrudTree_1.CrudTree}[u],B={actions:M,
//@ts-ignore
data:C,highlight:a,tsInterface:h,onEndReached:function(){var e,t,i=null===(e=g.data)||void 0===e?void 0:e.pages,r=i?i[i.length-1]:void 0;(null===(t=null==r?void 0:r.result)||void 0===t?void 0:t.hasMore)&&!g.isFetchingNextPage&&g.fetchNextPage()}};return(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,{children:[(0,jsx_runtime_1.jsxs)(react_with_native_1.Div,__assign({className:"px-8 lg:px-20 py-4"},{children:[D,q,b&&r&&isBetaEnabled?(0,jsx_runtime_1.jsx)(DatasetForm_1.DatasetForm,{modelName:r},b.key):null]})),Array.isArray(C)&&C.length>0&&k?(0,jsx_runtime_1.jsx)(k,__assign({},B)):null]})};exports.ModelComponent=ModelComponent;
//# sourceMappingURL=ModelComponent.js.map