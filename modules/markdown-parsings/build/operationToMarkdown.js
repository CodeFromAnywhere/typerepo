"use strict";var __awaiter=this&&this.__awaiter||function(e,n,r,t){return new(r||(r=Promise))((function(o,a){function i(e){try{l(t.next(e))}catch(e){a(e)}}function s(e){try{l(t.throw(e))}catch(e){a(e)}}function l(e){var n;e.done?o(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,s)}l((t=t.apply(e,n||[])).next())}))},__generator=this&&this.__generator||function(e,n){var r,t,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,t&&(o=2&a[0]?t.return:a[0]?t.throw||((o=t.return)&&o.call(t),0):t.next)&&!(o=o.call(t,a[1])).done)return o;switch(t=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,t=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=n.call(e,i)}catch(e){a=[6,e],t=0}finally{r=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.operationToMarkdown=exports.getMergedMarkdownOutlineUrl=void 0;var get_path_1=require("get-path"),log_1=require("log"),database_1=require("database"),js_util_1=require("js-util"),filename_conventions_1=require("filename-conventions"),markdown_parse_js_1=require("markdown-parse-js"),fs_util_1=require("fs-util"),get_package_json_1=require("get-package-json"),read_json_file_1=require("read-json-file"),merge_1=require("./parsing/merge"),bundleFolderWithMarkdown_1=require("./bundleFolderWithMarkdown"),tsInterfaceToMarkdownString_1=require("./tsInterfaceToMarkdownString"),getFunctionsInfo_1=require("./getFunctionsInfo"),tsVariableToMarkdownString_1=require("./tsVariableToMarkdownString"),getMergedMarkdownOutlineUrl=function(e){return{title:e,hashtagPath:(0,markdown_parse_js_1.getImplicitId)(e)}};exports.getMergedMarkdownOutlineUrl=getMergedMarkdownOutlineUrl;
/**
 * converts an operation and all its contents into a flat markdown file that contains the needed information. configurable.
 *
 * markdown for reading (so there are no links)
 */
var operationToMarkdown=function(e){return __awaiter(void 0,void 0,void 0,(function(){var n,r,t,o,a,i,s,l,d,c,u,_,p,g,f,v,w,k,m,h,M,b,j,S,T,y,P,x,I,O,F,q,D,z,W,J,N,U,V,E,R,C,A,G;return __generator(this,(function(L){switch(L.label){case 0:return e.isSummary,n=e.manualProjectRoot,r=e.operationName,e.mergeDocsInline,t=e.returnType,(o=n||(0,get_path_1.getProjectRoot)())?[4/*yield*/,(0,get_path_1.getOperationPath)(r,{manualProjectRoot:o})]:((0,log_1.log)("Projectroot not found",{type:"error"}),[2/*return*/]);case 1:return(a=L.sent())?[4/*yield*/,database_1.db.get("OperationConfig",{operationName:r})]:((0,log_1.log)("Operation not found",{type:"error"}),[2/*return*/]);case 2:return i=L.sent()[0],s=null==i?void 0:i.markdown,[4/*yield*/,(0,get_package_json_1.getPackageJson)({operationFolderPath:a})];case 3:return L.sent(),l=fs_util_1.path.join(a,filename_conventions_1.databaseFolderName,"operation-index.json"),[4/*yield*/,(0,read_json_file_1.readJsonFile)(l)];case 4:return d=L.sent(),"Size: ".concat(null===(J=null===(W=null==d?void 0:d.size)||void 0===W?void 0:W.codeSize)||void 0===J?void 0:J.lines," LOC, ").concat(void 0!==(null===(U=null===(N=null==d?void 0:d.size)||void 0===N?void 0:N.dataSize)||void 0===U?void 0:U.characters)?"".concat(null===(E=null===(V=null==d?void 0:d.size)||void 0===V?void 0:V.dataSize)||void 0===E?void 0:E.characters," data characters, "):"").concat(void 0!==(null===(C=null===(R=null==d?void 0:d.size)||void 0===R?void 0:R.textSize)||void 0===C?void 0:C.characters)?"".concat(null===(G=null===(A=null==d?void 0:d.size)||void 0===A?void 0:A.textSize)||void 0===G?void 0:G.characters," text characters, "):""),d&&d.coreDependencies&&d.coreDependencies.length>0?d.coreDependencies.join(", "):"none",d&&d.operationDependencies&&d.operationDependencies.length>0?d.operationDependencies.join(", "):"none",d&&d.packageDependencies&&d.packageDependencies.length>0?d.packageDependencies.join(", "):"none",c="".concat(r," (").concat(null==d?void 0:d.classification," operation)\n\n").concat(s?"".concat(s,"\n\n"):""),u=(0,markdown_parse_js_1.mdToJsonParse)(c,r),_=fs_util_1.path.join(a,"docs"),fs_util_1.fs.existsSync(_)?[4/*yield*/,(0,bundleFolderWithMarkdown_1.bundleFolderWithMarkdown)("Docs",_,"docs")]:[3/*break*/,6];case 5:return g=L.sent(),[3/*break*/,7];case 6:g=void 0,L.label=7;case 7:return f=null==(p=g)?void 0:p.markdownParse,v=(null==p?void 0:p.outlineString)||"",[4/*yield*/,(0,getFunctionsInfo_1.getFunctionsInfo)(r)];case 8:return w=L.sent(),k=w.functionsMarkdownParse,m=w.functionsOutline,[4/*yield*/,database_1.db.get("TsInterface",{operationName:r})];case 9:return h=L.sent().filter((function(e){return e.isDbModel})),[4/*yield*/,database_1.db.get("TsInterface",{operationName:r})];case 10:return M=L.sent().filter((function(e){return!e.isDbModel&&!e.name.startsWith("NamedParameters<")})),[4/*yield*/,database_1.db.get("TsVariable",{operationName:r})];case 11:return b=L.sent(),j=h.length>0?h.map(tsInterfaceToMarkdownString_1.tsInterfaceToMarkdownString).join("\n\n"):void 0,S=M.length>0?M.map(tsInterfaceToMarkdownString_1.tsInterfaceToMarkdownString).join("\n\n"):void 0,T=b.length>0?b.map(tsVariableToMarkdownString_1.tsVariableToMarkdownString).join("\n\n"):void 0,y=j?(0,markdown_parse_js_1.mdToJsonParse)(j,"models"):void 0,P=S?(0,markdown_parse_js_1.mdToJsonParse)(S,"interfaces"):void 0,x=T?(0,markdown_parse_js_1.mdToJsonParse)(T,"variables"):void 0,I=(0,bundleFolderWithMarkdown_1.makeOutlineMarkdownString)("Models",h.map((function(e){return(0,exports.getMergedMarkdownOutlineUrl)(e.name)}))),O=(0,bundleFolderWithMarkdown_1.makeOutlineMarkdownString)("Interfaces",M.map((function(e){return(0,exports.getMergedMarkdownOutlineUrl)(e.name)}))),F=(0,bundleFolderWithMarkdown_1.makeOutlineMarkdownString)("Variables",b.map((function(e){return(0,exports.getMergedMarkdownOutlineUrl)(e.name)}))),q=(0,markdown_parse_js_1.mdToJsonParse)("".concat(v).concat(m).concat(I).concat(O).concat(F),"outline"),D=(0,merge_1.mergeMarkdownParse)([u,q,f,k,y,P,x].filter(js_util_1.notEmpty)).merged,z=void 0,"parse"!==t&&(z=(0,markdown_parse_js_1.markdownParseToMarkdownString)(D)),("save"===t||!t)&&z?[4/*yield*/,fs_util_1.fs.writeFile(fs_util_1.path.join(a,"README.md"),z,"utf8")]:[3/*break*/,13];case 12:L.sent(),L.label=13;case 13:return[2/*return*/,"parse"===t?D:"string"===t?z:void 0]}}))}))};exports.operationToMarkdown=operationToMarkdown;
//# sourceMappingURL=operationToMarkdown.js.map