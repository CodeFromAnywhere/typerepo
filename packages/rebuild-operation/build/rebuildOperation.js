"use strict";var __assign=this&&this.__assign||function(){return __assign=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var o in n=arguments[t])Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o]);return e},__assign.apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,n,t,r){return new(t||(t=Promise))((function(o,a){function i(e){try{l(r.next(e))}catch(e){a(e)}}function s(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(i,s)}l((r=r.apply(e,n||[])).next())}))},__generator=this&&this.__generator||function(e,n){var t,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(t)throw new TypeError("Generator is already executing.");for(;i;)try{if(t=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=n.call(e,i)}catch(e){a=[6,e],r=0}finally{t=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},__spreadArray=this&&this.__spreadArray||function(e,n,t){if(t||2===arguments.length)for(var r,o=0,a=n.length;o<a;o++)!r&&o in n||(r||(r=Array.prototype.slice.call(n,0,o)),r[o]=n[o]);return e.concat(r||Array.prototype.slice.call(n))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.rebuildOperation=void 0;
// node wrappers
var run_child_process_1=require("run-child-process"),log_1=require("log"),cleanup_typescript_database_1=require("cleanup-typescript-database"),database_1=require("database"),generate_index_1=require("generate-index"),js_util_1=require("js-util"),operation_util_1=require("operation-util"),markdown_parsings_1=require("markdown-parsings"),one_by_one_1=require("one-by-one"),get_package_source_paths_1=require("get-package-source-paths"),lint_1=require("lint"),get_path_1=require("get-path"),fs_util_1=require("fs-util"),filename_conventions_1=require("filename-conventions"),shouldSkip_1=require("./shouldSkip"),isOperationBuildNeeded_1=require("./isOperationBuildNeeded"),yarnBuild_1=require("./yarnBuild"),exitIfProcessDependenciesChange_1=require("./exitIfProcessDependenciesChange"),executeCommandQuietUnlessFail_1=require("./executeCommandQuietUnlessFail"),isSdkOperation_1=require("./isSdkOperation"),rebuildOperation=function(e){var n=e.operationBasePath,t=e.manualProjectRoot,r=e.filePaths,o=e.force,a=e.debug,i=e.noExit,s=e.stack,l=void 0===s?[]:s,c=e.updatedAt,u=e.noUnresolvedRebuilding;return __awaiter(void 0,void 0,void 0,(function(){var e,s,p,d,_,g,f,m,b,h,y,v,x,P;return __generator(this,(function(w){switch(w.label){case 0:return e=(0,fs_util_1.getLastFolder)(n),(0,isSdkOperation_1.isSdkOperation)(n)||(0,filename_conventions_1.isGeneratedOperation)(n)?(console.log("not going to rebuild sdk operation: ".concat(e)),[2/*return*/,!1]):(s="".concat(l.map((function(){return"--"})).join("")).concat(e,": "),(0,log_1.log)("".concat(s,"Rebuilding").concat(l.length>0?"(coming from ".concat(l.join(", "),")"):""),{type:"important"}),(0,log_1.log)("".concat(s,"Pre-index lint"),{type:"important"}),[4/*yield*/,(0,lint_1.preIndexLint)({operationFolderPath:n})]);case 1:return(p=w.sent()).length>0?((0,log_1.log)("".concat(s,"Operation cannot be built, we've got problem(s)"),{type:"warning"}),(0,log_1.log)(p.join("\n"),{type:"warning"}),[4/*yield*/,database_1.db.update("OperationIndex",(function(){return!0}),(function(e){return __assign(__assign({},e),{lintProblems:p})}),{operationName:e})]):[3/*break*/,3];case 2:return w.sent(),[2/*return*/,!1];case 3:return[4/*yield*/,(0,shouldSkip_1.shouldSkip)({operationBasePath:n,debug:a,force:o,rebuildUpdatedAt:c})];case 4:return w.sent()?((0,log_1.log)("Skipping ".concat(e)),[2/*return*/,!0]):[4/*yield*/,(0,cleanup_typescript_database_1.cleanupTsDatabase)(e)];case 5:return d=w.sent(),(0,log_1.log)((null==d?void 0:d.amountRemoved)?"Removed ".concat(null==d?void 0:d.amountRemoved," ts db instances"):"Nothing to clean up",{type:"success"}),(0,executeCommandQuietUnlessFail_1.executeCommandQuietUnlessFail)({command:"yarn --offline",cwd:n,description:"".concat(s,"Installing")}),
// 2a) finding imports/exports and writing them to index
// TODO: we can also just check if build folder and index.js exist before looking at the import statements. These are easy to detect and when that happens we don't need to do the things below.
(0,log_1.log)("".concat(s,"Getting imports/exports"),{type:"important"}),[4/*yield*/,(0,run_child_process_1.runChildProcess)({operationFolderName:"get-imports-exports",scriptFileName:"findAndWriteImportsExports.cli",args:t?[n,t]:[n]})];case 6:return w.sent(),"sdk"===e?[3/*break*/,14]:[4/*yield*/,database_1.db.get("TsImport",{operationName:e,manualProjectRoot:t})];case 7:return y=w.sent(),(_=y.filter((function(e){return e.isAbsolute&&e.isModuleFromMonorepo&&!e.isModuleResolved})).map((function(e){return e.module})).filter(js_util_1.onlyUnique)).length>0?u?((0,log_1.log)("rebuilding the unresolved modules didn't work. Probably some indexation fails!",{type:"error"}),[4/*yield*/,database_1.db.update("OperationIndex",(function(){return!0}),(function(e){return __assign(__assign({},e),{dependenciesBuildsFailed:!0})}),{operationName:e})]):[3/*break*/,9]:[3/*break*/,13];case 8:return w.sent(),[2/*return*/,!1];case 9:return(0,log_1.log)("".concat(s,"We need to rebuild ").concat(_.length," operations because they have conflicts (").concat(_.join(", "),")"),{type:"warning"}),[4/*yield*/,(0,one_by_one_1.oneByOne)(_,(function(r){return __awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(o){switch(o.label){case 0:return[4/*yield*/,(0,get_path_1.getOperationPath)(r,{manualProjectRoot:t})];case 1:return o.sent()?r===e||l.includes(r)?((0,log_1.log)("".concat(s,"cyclic dep"),{type:"warning"}),[2/*return*/,!1]):(console.log("".concat(s,"diving into new rebuildOperation "),{operationName:e,stack:l,unresolvedOperationName:r}),[2/*return*/,(0,exports.rebuildOperation)({manualProjectRoot:t,operationBasePath:n,stack:l.concat([r]),debug:a,
// can't skip this one because it is a dependency
// however, skipping is very well defined. we can skip if shouldSkip is true!
// force: true,
noExit:i})]):((0,log_1.log)("".concat(s).concat(r," not found"),{type:"warning"}),[2/*return*/,!1])}}))}))}))];case 10:return g=w.sent(),(0,js_util_1.isAllTrue)(g)?[3/*break*/,12]:((0,log_1.log)("".concat(s,"something failed! returning")),[4/*yield*/,database_1.db.update("OperationIndex",(function(){return!0}),(function(e){return __assign(__assign({},e),{dependenciesBuildsFailed:!0})}),{operationName:e})]);case 11:return w.sent(),[2/*return*/,!1];case 12:
// NB: all files on purpose...
return(0,log_1.log)("".concat(s,"rebuilding ourselves again")),[2/*return*/,(0,exports.rebuildOperation)({manualProjectRoot:t,operationBasePath:n,debug:a,force:o,noExit:i,noUnresolvedRebuilding:!0,stack:l.concat([e])})];case 13:(0,log_1.log)("".concat(s,"all imports were resolved")),w.label=14;case 14:
// 2b) compiling and writing build errors to index
return(0,log_1.log)("".concat(s,"writing build errors to index"),{type:"important"}),[4/*yield*/,(0,run_child_process_1.runChildProcess)({operationFolderName:"compile-typescript",scriptFileName:"writeBuildErrors.cli",args:t?[n,t]:[n]})];case 15:return w.sent(),r?[3/*break*/,18]:(m=(f=Promise).all,[4/*yield*/,(0,get_package_source_paths_1.getPackageSourcePaths)({operationBasePath:n,ignoreIndexFiles:!0})]);case 16:return[4/*yield*/,m.apply(f,[w.sent()])];case 17:
//files from src
r=w.sent().filter(js_util_1.notEmpty),w.label=18;case 18:return 0===r.length?(0,log_1.log)("".concat(s,"No files found for operation ").concat(e),{type:"error"}):(0,log_1.log)("".concat(s).concat(r.length," files to index:"),{type:"important"}),[4/*yield*/,(0,run_child_process_1.runChildProcess)({operationFolderName:"index-typescript",scriptFileName:"cli",args:__spreadArray(__spreadArray([],r,!0),[t||"null"],!1)})];case 19:return w.sent(),[4/*yield*/,(0,generate_index_1.generateSimpleIndex)({operationName:e,manualProjectRoot:t})];case 20:return w.sent(),b=(0,isOperationBuildNeeded_1.isOperationBuildNeeded)(n),h=!0,b?[4/*yield*/,(0,yarnBuild_1.yarnBuild)(n,{rmFirst:!1})]:[3/*break*/,24];case 21:return h=w.sent(),[4/*yield*/,database_1.db.get("TsImport",{manualProjectRoot:t})];case 22:return y=w.sent(),v=y.filter((function(n){return n.isModuleFromMonorepo&&n.module===e})).map((function(e){return e.operationName})).filter(js_util_1.onlyUnique).filter(js_util_1.notEmpty),x=__spreadArray([e],v,!0),P=x.map((function(e){
// NB: we need this to be a child process because it requires the tests from the index, and that file changes, while normally a require will be cached. We can't easily invalidate the cache because it can come from many files.
return(0,run_child_process_1.runChildProcess)({operationFolderName:"k-test",scriptFileName:"runTestsForOperation.cli",args:t?[e,t]:[e]})})),[4/*yield*/,Promise.all(P)];case 23:w.sent(),w.label=24;case 24:return[4/*yield*/,database_1.db.update("OperationIndex",(function(){return!0}),(function(e){return __assign(__assign({},e),{buildSucceeded:h})}),{operationName:e})];case 25:
// make a readme of the new index
return w.sent(),[4/*yield*/,(0,markdown_parsings_1.operationToMarkdown)({operationName:e,mergeDocsInline:!0,manualProjectRoot:t,returnType:"save"})];case 26:
// make a readme of the new index
return w.sent(),[4/*yield*/,database_1.db.update("OperationIndex",(function(){return!0}),(function(e){return __assign(__assign({},e),{indexImportExportError:"",lintProblems:p})}),{operationName:e})];case 27:return w.sent(),[4/*yield*/,(0,operation_util_1.recalculateOperationIndexJson)(n)];case 28:return w.sent(),i?[3/*break*/,30]:[4/*yield*/,(0,exitIfProcessDependenciesChange_1.exitIfProcessDependenciesChanged)(e,t)];case 29:w.sent(),w.label=30;case 30:return[2/*return*/,!0]}}))}))};
// monorepo
exports.rebuildOperation=rebuildOperation;
//# sourceMappingURL=rebuildOperation.js.map